{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///app/src/proxy.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport type { NextRequest } from \"next/server\"\r\nimport { jwtVerify } from \"jose\"\r\n\r\nexport async function proxy(req: NextRequest) {\r\n\r\n  const { pathname, search } = req.nextUrl\r\n  const token = req.cookies.get(\"authToken\")?.value\r\n\r\n  // ✅ ข้าม path ที่ไม่ต้องตรวจ token\r\n  const skipPattern = /^\\/api\\/(login|logout|auth(?:\\/.*)?)$/i;\r\n\r\n\r\n  if (skipPattern.test(pathname)) {\r\n    return NextResponse.next()\r\n  }\r\n\r\n  const isApi = pathname.startsWith(\"/api/\")\r\n\r\n  // ✅ ฟังก์ชันสร้าง URL redirect พร้อม path เดิม\r\n  const buildLoginRedirect = () => {\r\n    const loginUrl = new URL(\"/login\", req.url)\r\n    // รวม path + query string เดิม\r\n    const fullPath = pathname + (search || \"\")\r\n    loginUrl.searchParams.set(\"redirect\", fullPath)\r\n    return loginUrl\r\n  }\r\n\r\n  // ❌ ไม่มี token\r\n  if (!token) {\r\n    if (isApi) {\r\n      return NextResponse.json(\r\n        {\r\n          success: false,\r\n          code: \"Unauthorized\",\r\n          message: \"Session หมดอายุ กรุณาเข้าสู่ระบบใหม่\",\r\n          path: pathname, // บอกว่า API ไหนโดน\r\n        },\r\n        { status: 401 }\r\n      )\r\n    }\r\n    return NextResponse.redirect(buildLoginRedirect())\r\n  }\r\n\r\n  try {\r\n    // ✅ ตรวจสอบ JWT\r\n    const secretKey = process.env.JWT_SECRET\r\n    if (!secretKey) throw new Error(\"Missing JWT_SECRET\")\r\n\r\n    const secret = new TextEncoder().encode(secretKey)\r\n    const { payload } = await jwtVerify(token, secret)\r\n\r\n    // ✅ ตรวจวันหมดอายุ\r\n    if (payload.exp && payload.exp * 1000 < Date.now()) {\r\n      throw new Error(\"Token expired\")\r\n    }\r\n\r\n    return NextResponse.next()\r\n  } catch (error) {\r\n    console.warn(\"⚠️ Invalid or expired token:\", error)\r\n\r\n    // ลบ cookie กัน loop\r\n    const response = isApi\r\n      ? NextResponse.json(\r\n        {\r\n          success: false,\r\n          code: \"Unauthorized\",\r\n          message: \"Session หมดอายุ กรุณาเข้าสู่ระบบใหม่\",\r\n          path: pathname,\r\n        },\r\n        { status: 401 }\r\n      )\r\n      : NextResponse.redirect(buildLoginRedirect())\r\n\r\n    response.cookies.delete(\"authToken\")\r\n    return response\r\n  }\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    \"/api/:path*\",\r\n    \"/personnel/:path*\",\r\n    \"/register/:path*\",\r\n    \"/curriculums/:path*\",\r\n    \"/enroll/:path*\",\r\n    \"/evaluation/:path*\",\r\n    \"/salary/:path*\",\r\n    \"/profile/:path*\",\r\n  ],\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AAEO,eAAe,MAAM,GAAgB;IAE1C,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,GAAG,IAAI,OAAO;IACxC,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAE5C,mCAAmC;IACnC,MAAM,cAAc;IAGpB,IAAI,YAAY,IAAI,CAAC,WAAW;QAC9B,OAAO,8IAAY,CAAC,IAAI;IAC1B;IAEA,MAAM,QAAQ,SAAS,UAAU,CAAC;IAElC,+CAA+C;IAC/C,MAAM,qBAAqB;QACzB,MAAM,WAAW,IAAI,IAAI,UAAU,IAAI,GAAG;QAC1C,+BAA+B;QAC/B,MAAM,WAAW,WAAW,CAAC,UAAU,EAAE;QACzC,SAAS,YAAY,CAAC,GAAG,CAAC,YAAY;QACtC,OAAO;IACT;IAEA,gBAAgB;IAChB,IAAI,CAAC,OAAO;QACV,IAAI,OAAO;YACT,OAAO,8IAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,MAAM;gBACN,SAAS;gBACT,MAAM;YACR,GACA;gBAAE,QAAQ;YAAI;QAElB;QACA,OAAO,8IAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI;QACF,gBAAgB;QAChB,MAAM,YAAY,QAAQ,GAAG,CAAC,UAAU;QACxC,IAAI,CAAC,WAAW,MAAM,IAAI,MAAM;QAEhC,MAAM,SAAS,IAAI,cAAc,MAAM,CAAC;QACxC,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,oKAAS,EAAC,OAAO;QAE3C,mBAAmB;QACnB,IAAI,QAAQ,GAAG,IAAI,QAAQ,GAAG,GAAG,OAAO,KAAK,GAAG,IAAI;YAClD,MAAM,IAAI,MAAM;QAClB;QAEA,OAAO,8IAAY,CAAC,IAAI;IAC1B,EAAE,OAAO,OAAO;QACd,QAAQ,IAAI,CAAC,gCAAgC;QAE7C,qBAAqB;QACrB,MAAM,WAAW,QACb,8IAAY,CAAC,IAAI,CACjB;YACE,SAAS;YACT,MAAM;YACN,SAAS;YACT,MAAM;QACR,GACA;YAAE,QAAQ;QAAI,KAEd,8IAAY,CAAC,QAAQ,CAAC;QAE1B,SAAS,OAAO,CAAC,MAAM,CAAC;QACxB,OAAO;IACT;AACF;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;AACH","debugId":null}}]
}